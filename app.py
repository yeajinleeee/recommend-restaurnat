import streamlit as st
from streamlit_geolocation import streamlit_geolocation
import pandas as pd
from haversine import haversine
import requests
import concurrent.futures
import psycopg2
from supabase import create_client, Client
import os

url: str = "https://yamiretxhfjduvaktqhx.supabase.co"
key: str = "sb_publishable_J4ipWe8Qp6JpxFHBtBO3PA_P4-Mcg5Q"
supabase: Client = create_client(url, key)    

# CSV íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
df = pd.read_csv('restaurant_cleaned_data.csv', encoding='utf-8')


st.title("ë‚ ì”¨ + ìœ„ì¹˜ ê¸°ë°˜ ìŒì‹ì  ì¶”ì²œğŸŒ¨ï¸")

# ì—…ì¢…ë³„ ì¹´í…Œê³ ë¦¬ ë”•ì…”ë„ˆë¦¬ ì •ì˜
category_map = {
    "ì‹œì›í•œ ìŒì‹": ['ëƒ‰ë©´ ì „ë¬¸ì ', 'êµ­ìˆ˜ ì „ë¬¸ì ', 'ë§‰êµ­ìˆ˜ ì „ë¬¸ì ', 'ì•„ì´ìŠ¤í¬ë¦¼ ê°€ê²Œ', 'ì†Œë°” ì „ë¬¸ì '],
    "ëœ¨ëˆí•œ êµ­ë¬¼": ['ìŒ€êµ­ìˆ˜ ì „ë¬¸ì‹ë‹¹', 'ì¼ë³¸ë¼ë©´ ì „ë¬¸ì‹ë‹¹', 'ê°ìíƒ• ì „ë¬¸ì ', 'ì¶”ì–´íƒ• ì „ë¬¸ì ', 'ì¹¼êµ­ìˆ˜ì§‘', 'ë¶€ëŒ€ì°Œê°œ ì „ë¬¸ì ', 'ë³´ì‹ íƒ•ì§‘', 'ì•„êµ¬ì „ë¬¸ì ',  'ì„¤ë íƒ• ì „ë¬¸ì ', 'ì§¬ë½• ì „ë¬¸ì ', 'ë¼ì§€êµ­ë°¥ ì „ë¬¸ì ', 'ìš°ë™ ì „ë¬¸ì ', 'ì‚¼ê³„íƒ• ì „ë¬¸ì ', 'í•´ì¥êµ­ ì „ë¬¸ì ', 'ê³°íƒ•ì „ë¬¸ì ', 'ì¶”ì–´íƒ• ì „ë¬¸ì ', 'ì¤‘êµ­ êµ­ìˆ˜ë¥˜ ì „ë¬¸ì ', 'íƒ•ë¥˜(ë³´ì‹ ìš©)'],
    "ë§¤ì½¤í•œ ìŒì‹": ['ê°ìíƒ• ì „ë¬¸ì ', 'ë–¡ë³¶ì´ ì „ë¬¸ì ', 'ì§¬ë½• ì „ë¬¸ì ','ë‹­ê°ˆë¹„ì „ë¬¸ì ', 'ë¶€ëŒ€ì°Œê°œ ì „ë¬¸ì '],
    "ë“ ë“ í•œ í•œë¼": ['í•œì‹', 'ìˆœëŒ€ ì „ë¬¸ì ', 'í•œì‹ë‹¹', 'ê³±ì°½êµ¬ì´ ì „ë¬¸ì ', 'ì‹ìœ¡(ìˆ¯ë¶ˆêµ¬ì´)', 'ë¶ˆê³ ê¸° ì „ë¬¸ì ', 'í†µë‹­(ì¹˜í‚¨)', 
                 'ê°ìíƒ• ì „ë¬¸ì ', 'ë‹­ìš”ë¦¬ì „ë¬¸ì ', 'ì¶”ì–´íƒ• ì „ë¬¸ì ', 'ì¹¼êµ­ìˆ˜ì§‘', 'ë¶€ëŒ€ì°Œê°œ ì „ë¬¸ì ', 'ëˆê¹ŒìŠ¤ ì „ë¬¸ì‹ë‹¹', 
                 'ì–‘ê³ ê¸° ë°”ë² í ì „ë¬¸ì ', 'ì°œë‹­ ì „ë¬¸ì ', 'íƒ•ë¥˜(ë³´ì‹ ìš©)', 'ì„¤ë íƒ• ì „ë¬¸ì ', 'ë‹­ê°ˆë¹„ì „ë¬¸ì ', 'íŠ€ê¹€ë®ë°¥ ì „ë¬¸ì ', 
                 'ë¼ì§€êµ­ë°¥ ì „ë¬¸ì ', 'ì •ìœ¡ì‹ë‹¹', 'ì‡ ê³ ê¸°ë®ë°¥ ì „ë¬¸ì ', 'ìŠ¤í…Œì´í¬ ì „ë¬¸ì ', 'ì¼ë³¸ì‹ ì¹´ë ˆ ì „ë¬¸ì‹ë‹¹', 
                 'í•´ì¥êµ­ ì „ë¬¸ì ', 'ê³°íƒ•ì „ë¬¸ì ', 'ìŒ€ ì „ë¬¸ì‹ë‹¹', 'ë³´ìŒˆ ì „ë¬¸ì '],
    "ìœ¡ë¥˜êµ¬ì´/ê³ ê¸°íŒŒí‹°": ['í•œêµ­ì‹ ì†Œê³ ê¸° ì „ë¬¸ ìŒì‹ì ', 'ê³±ì°½êµ¬ì´ ì „ë¬¸ì ', 'í•œì‹ ê³ ê¸°êµ¬ì´ ë ˆìŠ¤í† ë‘', 'ì‚¼ê²¹ì‚´ ì „ë¬¸ì ', 'ì‹ìœ¡(ìˆ¯ë¶ˆêµ¬ì´)',
                      'ë°” & ê·¸ë¦´', 'ê³ ê¸° ìš”ë¦¬ ì „ë¬¸ì ', 'ë¶ˆê³ ê¸° ì „ë¬¸ì ', 'í†µë‹­(ì¹˜í‚¨)', 'ì¡±ë°œê°€ê²Œ', 'ì¹˜í‚¨ ì „ë¬¸ì ', 
                      'ë‹­ìš”ë¦¬ì „ë¬¸ì ', 'ìˆ¯ë¶ˆêµ¬ì´/ë°”ë² íì „ë¬¸ì ', 'ê°ˆë¹„ ì „ë¬¸ ìŒì‹ì ', 'ê³±ì°½ì „ë¬¸ì ', 'ê¹€ë°¥(ë„ì‹œë½)', 'ë¶€ëŒ€ì°Œê°œ ì „ë¬¸ì ',
                      'ì–‘ê³ ê¸° ë°”ë² í ì „ë¬¸ì ', 'ì•¼í‚¤ë‹ˆì¿  ì „ë¬¸ì‹ë‹¹', 'ì„¤ë íƒ• ì „ë¬¸ì ', 'ë‹­ê°ˆë¹„ì „ë¬¸ì ', 'ì˜¤ë¸êµ¬ì´ì¹˜í‚¨ì§‘', 'ì •ìœ¡ì‹ë‹¹',
                      'ìŠ¤í…Œì´í¬ ì „ë¬¸ì ', 'ì˜¤ë¦¬êµ¬ì´ ì „ë¬¸ì ', 'ë¯¼ë¬¼ì¥ì–´ì „ë¬¸ì ', 'ë§‰ì°½ ì „ë¬¸ì ', 'ë³´ìŒˆ ì „ë¬¸ì '],
    "ê°€ë³ê²Œ ê°„ë‹¨íˆ": ['ìŒì‹ì /ì¹´í˜', 'ì œê³¼ì ', 'ê¹€ë°¥ì „ë¬¸ì ', 'ê°„ì´ìŒì‹ì ', 'ë¸ŒëŸ°ì¹˜ ì‹ë‹¹', 'ë§Œë‘ ì „ë¬¸ì ', 'ë¶„ì‹', 'ìƒëŸ¬ë“œìƒµ', 
                  'ë§‰êµ­ìˆ˜ ì „ë¬¸ì ', 'íƒ€ì½” ë ˆìŠ¤í† ë‘', 'ìš°ë™ ì „ë¬¸ì ', 'ì¹˜í‚¨ìœ™ ì „ë¬¸ì‹ë‹¹', 'ìƒŒë“œìœ„ì¹˜ ê°€ê²Œ', 'ë„ì‹œë½ ì „ë¬¸ì ', 
                  'ì†Œë°” ì „ë¬¸ì ', 'íŠ€ê¹€ ì „ë¬¸ì‹ë‹¹', 'ê¼¬ì¹˜êµ¬ì´ ì „ë¬¸ì‹ë‹¹', 'ì–´ë¬µ ì „ë¬¸ì‹ë‹¹', 'ë”¤ì„¬ ì „ë¬¸ ë ˆìŠ¤í† ë‘'],
    "ìˆ  í•œì” í•˜ê¸° ì¢‹ì€ë‚ ": ['ìˆ ì§‘', 'í˜¸í”„/ìƒë§¥ì£¼ì§‘', 'í˜¸í”„/í†µë‹­', 'ì •ì¢…/ëŒ€í¬ì§‘/ì†Œì£¼ë°©', 'ì´ìì¹´ì•¼', 'ì¹˜í‚¨ ì „ë¬¸ì ', 'ì™€ì¸ ë°”', 
                      'ë§‰ê±¸ë¦¬ ì „ë¬¸ì ', 'ì™€ì¸ ì „ë¬¸ì ', 'ìˆ¯ë¶ˆêµ¬ì´/ë°”ë² íì „ë¬¸ì ', 'ì¹µí…Œì¼ë°”', 'ë¹ˆëŒ€ë–¡ ì „ë¬¸ì ', 'ê³±ì°½ì „ë¬¸ì ', 
                      'ë¶€ëŒ€ì°Œê°œ ì „ë¬¸ì ', 'ë§¥ì£¼ ì „ë¬¸ì ', 'ì˜¤ì½”ë…¸ë¯¸ì•¼ë¼ ì „ë¬¸ì‹ë‹¹', 'í¬ì¥ë§ˆì°¨', 'ê¼¬ì¹˜íŠ€ê¹€ ì „ë¬¸ì ', 'íŠ€ê¹€ ì „ë¬¸ì‹ë‹¹', 
                      'ê¼¬ì¹˜êµ¬ì´ ì „ë¬¸ì‹ë‹¹', 'ì–´ë¬µ ì „ë¬¸ì‹ë‹¹', 'ë”¤ì„¬ ì „ë¬¸ ë ˆìŠ¤í† ë‘', 'ë³´ìŒˆ ì „ë¬¸ì '],
    "ë””ì €íŠ¸/ì¹´í˜": ['ì»¤í”¼ìˆ/ì»¤í”¼ ì „ë¬¸ì ', 'ì¹´í˜', 'ìŒì‹ì /ì¹´í˜', 'ì œê³¼ì ', 'ì¹´í˜í…Œë¦¬ì•„', 'ë¸ŒëŸ°ì¹˜ ì‹ë‹¹', 'ë””ì €íŠ¸ ì „ë¬¸ ë ˆìŠ¤í† ë‘', 
                'ê¹Œí˜', 'ë””ì €íŠ¸ ì „ë¬¸ì ', 'ì—ìŠ¤í”„ë ˆì†Œ ë°”', 'ì•„ì´ìŠ¤í¬ë¦¼ ê°€ê²Œ', 'í¬ë ˆí”„ë¦¬', 'ìƒŒë“œìœ„ì¹˜ ê°€ê²Œ', 'ìŒë£Œ', 'ì‹ìŒë£Œ', 
                'í† ìŠ¤íŠ¸ ë ˆìŠ¤í† ë‘'],
    "ì´êµ­ì ì¸ ìŒì‹": ['í•˜ì™€ì´ ë ˆìŠ¤í† ë‘', 'ì¼ì‹ë‹¹ ë° ì¼ì •ì‹ì§‘', 'íšŒ ì „ë¬¸ì ', 'ì¤‘êµ­ ìŒì‹ì ', 'ì´íƒˆë¦¬ì•„ ìŒì‹ì ', 'ì•„ì‹œì•„ ë ˆìŠ¤í† ë‘',
                 'ìŒ€êµ­ìˆ˜ ì „ë¬¸ì‹ë‹¹', 'ì¼ì‹', 'íƒœêµ­ ìŒì‹ì ', 'ì¼ë³¸ë¼ë©´ ì „ë¬¸ì‹ë‹¹', 'í“¨ì „ ìŒì‹ì ', 'ê²½ì–‘ì‹', 
                 'ì™¸êµ­ìŒì‹ì „ë¬¸ì (ì¸ë„,íƒœêµ­ë“±)', 'ìŠ¤ì‹œ/ì´ˆë°¥ì§‘', 'ì´ìì¹´ì•¼', 'ë¶€ë¦¬í†  ë ˆìŠ¤í† ë‘', 'ì„œì–‘ìŒì‹ì „ë¬¸ì ', 'ì¸ë„ ë ˆìŠ¤í† ë‘', 
                 'ìŠ¤íŒŒê²Œí‹° ì „ë¬¸ì ', 'ë² íŠ¸ë‚¨ ìŒì‹ì ', 'ì¤‘êµ­ì‹', 'ì—í‹°ì˜¤í”¼ì•„ ìŒì‹ì ', 'ì–‘ê³ ê¸° ë°”ë² í ì „ë¬¸ì ', 'ë©•ì‹œì½” ìŒì‹ì ',
                 'ë…ì¼ ìŒì‹ì ', 'ì•¼í‚¤ë‹ˆì¿  ì „ë¬¸ì‹ë‹¹', 'ìŠ¤í˜ì¸ìŒì‹ì ', 'íƒ€ì½” ë ˆìŠ¤í† ë‘', 'íŠ€ê¹€ë®ë°¥ ì „ë¬¸ì ', 
                 'ì¼ì‹ ê¼¬ì¹˜ ë° íŠ€ê¹€ ì „ë¬¸ì ', 'íšŒì „ì´ˆë°¥ì§‘', 'ëŒ€ë§Œ ë ˆìŠ¤í† ë‘', 'ì¼ë³¸ì‹ ì¹´ë ˆ ì „ë¬¸ì‹ë‹¹', 
                 'ì¼ë³¸ì‹ ëœì¥ ëˆê¹ŒìŠ¤ ì „ë¬¸ì ', 'ì•„ë©”ë¦¬ì¹¸(í˜„ëŒ€ì‹) ë ˆìŠ¤í† ë‘', 'ì•„ë©”ë¦¬ì¹¸ ë ˆìŠ¤í† ë‘', 'ì¼ë³¸ ìŠ¤í…Œì´í¬ ì „ë¬¸ì ', 
                 'ë”¤ì„¬ ì „ë¬¸ ë ˆìŠ¤í† ë‘', 'ì¤‘êµ­ êµ­ìˆ˜ë¥˜ ì „ë¬¸ì '],
    "í•´ì‚°ë¬¼/ìƒì„ ìš”ë¦¬": ['ì¼ë³¸ ìŒì‹ì ', 'ì¼ì‹ë‹¹ ë° ì¼ì •ì‹ì§‘', 'íšŒ ì „ë¬¸ì ', 'í•´ì‚°ë¬¼ ìš”ë¦¬ ì „ë¬¸ì‹ë‹¹', 'ì¼ì‹', 'íšŸì§‘', 'ì´ìì¹´ì•¼', 
                   'ìŠ¤ì‹œ/ì´ˆë°¥ì§‘', 'ë¯¼ë¬¼ì¥ì–´ ìš”ë¦¬ ì „ë¬¸ì‹ë‹¹', 'ì¶”ì–´íƒ• ì „ë¬¸ì ', 'ì°¸ì¹˜ ì „ë¬¸ì ', 'ì•„êµ¬ì „ë¬¸ì ', 'íšŒì „ì´ˆë°¥ì§‘', 
                   'ìƒì„  ë ˆìŠ¤í† ë‘', 'ìƒíƒœ/ë™íƒœìš”ë¦¬ ì „ë¬¸ì ', 'ë°”ë‹¤ì¥ì–´ ìš”ë¦¬ ì „ë¬¸ì‹ë‹¹', 'í•´ì‚°ë¬¼', 'ë¯¼ë¬¼ì¥ì–´ì „ë¬¸ì ', 
                   'ê²Œ ìš”ë¦¬ ì „ë¬¸ì '],
}

#ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° 
location = streamlit_geolocation()
#st.caption(f"raw location: {location}")  # ë””ë²„ê¹…ìš©

if not location or location.get("latitude") is None:
    st.warning("ìœ„ì¹˜ì •ë³´ ë²„íŠ¼ì„ ëˆŒëŸ¬ í—ˆìš©í•´ì£¼ì„¸ìš”. (ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ê¶Œí•œ í—ˆìš© í•„ìˆ˜)")
    st.stop()

user_lat = 37.5665  #location["latitude"]
user_lon = 126.9780  #location["longitude"]
st.success(f"í˜„ì¬ ìœ„ì¹˜: ìœ„ë„ {user_lat}, ê²½ë„ {user_lon}")



#ë‚ ì”¨ api 
API_KEY = "56dfd0f8d8a24c9b492d704b63ddb493"

# ë‚ ì”¨ ì½”ë“œì— ë”°ë¥¸ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
weather_categories = {
    "Clear": ["ì´êµ­ì ì¸ ìŒì‹", "ë””ì €íŠ¸/ì¹´í˜", "ìˆ  í•œì” í•˜ê¸° ì¢‹ì€ ë‚ ", "ê°€ë³ê²Œ ê°„ë‹¨íˆ", "ì‹œì›í•œ ìŒì‹", "í•´ì‚°ë¬¼/ìƒì„ ìš”ë¦¬"],
    "Clouds": ["ë“ ë“ í•œ í•œë¼", "ëœ¨ëˆí•œ êµ­ë¬¼", "ë””ì €íŠ¸/ì¹´í˜", "ì‹œì›í•œ í•œë¼", "í•´ì‚°ë¬¼/ìƒì„ ìš”ë¦¬"],
    "Rain": ["ëœ¨ëˆí•œ êµ­ë¬¼", "ë§¤ì½¤í•œ ìŒì‹", "ìˆ  í•œì” í•˜ê¸° ì¢‹ì€ ë‚ ", "íŒ¨ìŠ¤íŠ¸í‘¸ë“œ/ë°°ë‹¬", "ì‹œì›í•œ í•œë¼"],
    "Drizzle": ["ë””ì €íŠ¸/ì¹´í˜", "ê°€ë³ê²Œ ê°„ë‹¨íˆ", "ê±´ê°•/ì±„ì‹/íŠ¹ìˆ˜ì‹ë‹¹", "í•´ì‚°ë¬¼/ìƒì„ ìš”ë¦¬"],
    "Thunderstorm": ["ìœ¡ë¥˜êµ¬ì´/ê³ ê¸°íŒŒí‹°", "ë“ ë“ í•œ í•œë¼", "íŒ¨ìŠ¤íŠ¸í‘¸ë“œ/ë°°ë‹¬"],
    "Snow": ["ëœ¨ëˆí•œ êµ­ë¬¼", "ìœ¡ë¥˜êµ¬ì´/ê³ ê¸°íŒŒí‹°", "ê°€ì¡±/ë‹¨ì²´íšŒì‹", "ë””ì €íŠ¸/ì¹´í˜", "í•´ì‚°ë¬¼/ìƒì„ ìš”ë¦¬"],
    "Mist": ["ê±´ê°•/ì±„ì‹/íŠ¹ìˆ˜ì‹ë‹¨", "ëœ¨ëˆí•œ êµ­ë¬¼", "ë°°ë‹¬"],
}

def get_weather(lat, lon):
    weather_url = (
        f"https://api.openweathermap.org/data/2.5/weather"
        f"?lat={user_lat}&lon={user_lon}&appid={API_KEY}&units=metric&lang=kr"
    )
    try:
        response = requests.get(weather_url)
        weather_data = response.json()

        # ë‚ ì”¨ ìƒíƒœ ì½”ë“œì™€ ì„¤ëª… ì¶”ì¶œ
        weather_main = weather_data['weather'][0]['main']  # ì˜ˆ: Clear, Rain, Snow
        weather_desc = weather_data['weather'][0]['description']
        temp = weather_data['main']['temp']

        return weather_main, weather_desc, temp
    except Exception as e:
        return None, None, None

#ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸° 
weather_main, weather_desc, temp = get_weather(user_lat, user_lon)

if weather_main:
    st.markdown(f"í˜„ì¬ ë‚ ì”¨: **{weather_desc}**")
    st.markdown(f"ê¸°ì˜¨: **{temp}Â°C**")

    # ë‚ ì”¨ ì½”ë“œì— í•´ë‹¹í•˜ëŠ” ì¹´í…Œê³ ë¦¬ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    if weather_main in weather_categories:
        st.markdown(f"### ì˜¤ëŠ˜ ì¶”ì²œ ë“œë¦¬ëŠ” ì¹´í…Œê³ ë¦¬:")
        
        selected_category = None
        # ê° ì¹´í…Œê³ ë¦¬ë¥¼ ë¸”ëŸ­ í˜•íƒœë¡œ ë²„íŠ¼ìœ¼ë¡œ ë§Œë“¤ê¸°
        for category in weather_categories[weather_main]:
            if st.button(category):
                selected_category = category

        # ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ì¶œë ¥
        if selected_category:
            st.markdown(f"**ì„ íƒí•œ ì¹´í…Œê³ ë¦¬:** {selected_category}")

            # ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” ì—…íƒœ êµ¬ë¶„ëª… ì¶œë ¥
            st.markdown(f"**{selected_category}**ì— í•´ë‹¹í•˜ëŠ” ì—…íƒœ êµ¬ë¶„ëª…:")
            
            #5ê°œì”© ë‚˜ëˆ„ì–´ ë³´ì—¬ì£¼ê¸°
            filtered_df = df[df['ì¹´í…Œê³ ë¦¬'] == selected_category]
            first_5_items = filtered_df.head(5)

            
            # ë‚˜ë¨¸ì§€ í•­ëª©ì€ "ë”ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ í‘œì‹œ
            if len(filtered_df) > 5:
                if st.button("ë”ë³´ê¸°"):
                    for item in category_map[selected_category][5:]:
                        st.write(item)
            
        else:
            st.warning("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.")   
    else:
        st.warning("ì¶”ì²œí•  ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.")
else:
    st.error("ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")



# # ë°˜ê²½ 1km(ë˜ëŠ” 500m) ë‚´ ìŒì‹ì : Supabase RPC
# try:
#     resp = supabase.rpc(
#         "get_restaurants_within_500m",
#         {"user_lat": user_lat, "user_lng": user_lon}
#     ).execute()

#     df = pd.DataFrame(resp.data or [])
#     st.subheader("ë°˜ê²½ 1km ì´ë‚´ ìŒì‹ì  ëª©ë¡")
#     st.write(f"ì „ì²´ í–‰ ê°œìˆ˜: {len(df)}")
#     st.dataframe(df)
# except Exception as e:
#     st.error(f"ìŒì‹ì  ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: {e}")
